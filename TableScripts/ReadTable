#! /bin/bash

DBase=$1

ls ./DBs/$DBase | grep -v '^schema_'

shopt -s extglob

read -p "Enter Table you want to read : " TableName

tb="DBs/$DBase/$TableName"
sc="DBs/$DBase/schema_$TableName"


if ! [[ -f $tb || -z $tb ]]
then
    echo "Wrong Table name"
    source ./TableScripts/TableMenu.sh
fi

echo Do you want to Read The whole table or select some rows ?
echo [1] Read whole table
echo [2] Select

select choice in 1 2

do
    case $choice in
        1)
            cat $tb
            source ./TableScripts/TableMenu.sh
        ;;
        2)
            
            #list the fields
            echo choose from these fields :
            awk 'BEGIN{FS=":"} NR>2 {print $1}' $sc
            
            read -p "Enter field you want to search for : " fname
            read -p "Enter field value : " val
            
            
            #check if the inputs are null
            
            if [[ -z $fname || -z $val ]]
            then
                echo Error NULL input
                source ./TableScripts/TableMenu.sh
            fi
            
            #check if fname doesn't exist
            flag=`awk 'BEGIN {FS=":" ; f=0} {if($1=="'$fname'"){f=1}} END{print f}' $sc`
            
            if [[ $flag -eq 0 ]]
            then
                echo Wrong field name
                source ./TableScripts/TableMenu.sh
            fi
            
            #check for datatype of value
            datatype=`awk 'BEGIN{FS=":"} {if($1=="'$fname'"){print$2}}' $sc`
            
            
            #if datatype is string
            if [[ $datatype = "string" ]]
            then
            # check if it contains a string or not
                if [[ -n $val ]]; then
                    dummy=1   #dummy event
                else
                    echo "Wrong data type in old value"
                    source ./TableScripts/TableMenu.sh
                fi
                
            fi
            
            # get field num from schema
            fn=$(awk 'BEGIN{FS=":"} NR > 2 {if ($1 == "'$fname'") print NR }' "$sc")
            
            # increment it as pk is in the first line
            fn=$((fn-2))
            
            # search for the value int the field number
            awk 'BEGIN{FS="|"} { if($'$fn' == "'$val'") print $0 }' $tb
            
            source ./TableScripts/TableMenu.sh
        ;;
        *)
            echo Wrong input
        ;;
        
    esac
done