#! /bin/bash
export LC_COLLATE=C 
shopt -s extglob

ourDataBase=$1

echo Tables List :

ls ./DBs/$ourDataBase | grep -v '^schema_'

read -p "Please enter Table you want to delete/delete-from : " t_name

t="./DBs/$ourDataBase/$t_name"
s="./DBs/$ourDataBase/schema_$t_name"

if ! [[ -f $t  || -z $t ]]
then
    echo "Wrong Table name"
    source ./TableScripts/TableMenu.sh
fi




deleteOptions=("Delete_Whole_Table" "Delete_From_Table" "Truncate_The_Table")

select choice in "${deleteOptions[@]}"

do
    case $choice in
        "Delete_Whole_Table")

            if [[ -f $t ]]; then
                 rm $t
                 rm $s
                 echo Table Deleted Successfully
            else
                echo This table does not exist !!
            fi

            source ./TableScripts/TableMenu.sh
        ;;
        "Delete_From_Table")

            # print fields
            awk 'BEGIN{FS=":"} NR > 2 {print $1}' $s

            read -p "Please enter the field you want to delete its row : " f_name

            #check existance of field
            flag=`awk 'BEGIN{FS=":" ; f=0} NR>2 {if($1 == "'$f_name'") {f=1}} END{print f}' $s`
            
            if [[ $flag = 0 ]]; then
                echo Wrong field name
                source ./TableScripts/TableMenu.sh
            fi

            read -p "Please enter the field  value : " f_value
            # select lines that do not match the pattern & store in another tmp file to be overrided in the same file.
            awk -v pattern="$f_value" '$0 !~ pattern' "$t" > temp && mv temp "$t"
            echo Deleted Successfuly
            source ./TableScripts/TableMenu.sh
        ;;
        "Truncate_The_Table")
            cat /dev/null > $t
            echo Table truncated successfully        
        ;;
        *)
            echo Wrong Input
        ;;
        
    esac
done
